# rust-kgdb Distributed Cluster - Docker Compose Configuration
#
# Development cluster with 1 coordinator + 3 executors
# Total: 9 partitions distributed across 3 executor nodes
#
# Usage:
#   docker-compose up -d          # Start cluster
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop cluster
#   docker-compose down -v        # Stop and remove volumes

version: '3.8'

services:
  # ============================================================================
  # Coordinator Node
  # ============================================================================
  coordinator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.coordinator
    container_name: rust-kgdb-coordinator
    hostname: coordinator
    ports:
      - "8080:8080"   # SPARQL HTTP endpoint
      - "9090:9090"   # gRPC (inter-cluster)
    environment:
      - RUST_LOG=info
      - NODE_ID=0
      - NODE_ROLE=coordinator
      - PARTITION_COUNT=9
      - HDRF_LAMBDA=1.0
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ============================================================================
  # Executor Node 1 (Partitions 0, 1, 2)
  # ============================================================================
  executor-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.executor
    container_name: rust-kgdb-executor-1
    hostname: executor-1
    environment:
      - RUST_LOG=info
      - NODE_ID=1
      - NODE_ROLE=executor
      - PARTITION_COUNT=9
      - PARTITIONS=0,1,2
      - COORDINATOR_ADDR=coordinator:9090
    volumes:
      - executor1-data:/data
    networks:
      - cluster-net
    depends_on:
      coordinator:
        condition: service_healthy
    restart: unless-stopped

  # ============================================================================
  # Executor Node 2 (Partitions 3, 4, 5)
  # ============================================================================
  executor-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.executor
    container_name: rust-kgdb-executor-2
    hostname: executor-2
    environment:
      - RUST_LOG=info
      - NODE_ID=2
      - NODE_ROLE=executor
      - PARTITION_COUNT=9
      - PARTITIONS=3,4,5
      - COORDINATOR_ADDR=coordinator:9090
    volumes:
      - executor2-data:/data
    networks:
      - cluster-net
    depends_on:
      coordinator:
        condition: service_healthy
    restart: unless-stopped

  # ============================================================================
  # Executor Node 3 (Partitions 6, 7, 8)
  # ============================================================================
  executor-3:
    build:
      context: ..
      dockerfile: docker/Dockerfile.executor
    container_name: rust-kgdb-executor-3
    hostname: executor-3
    environment:
      - RUST_LOG=info
      - NODE_ID=3
      - NODE_ROLE=executor
      - PARTITION_COUNT=9
      - PARTITIONS=6,7,8
      - COORDINATOR_ADDR=coordinator:9090
    volumes:
      - executor3-data:/data
    networks:
      - cluster-net
    depends_on:
      coordinator:
        condition: service_healthy
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  cluster-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# Volumes
# ============================================================================
volumes:
  executor1-data:
    driver: local
  executor2-data:
    driver: local
  executor3-data:
    driver: local
