<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó Self-Driving Car - rust-kgdb SPARQL Reasoning (2.78 ¬µs lookups)</title>
    <!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë         POWERED BY RUST-KGDB ONTOLOGY + REAL SPARQL EXECUTION            ‚ïë
    ‚ïë                                                                           ‚ïë
    ‚ïë  Backend: rust-kgdb HTTP Server (2.78 ¬µs lookups, 519 tests passing) (http://localhost:8080)                 ‚ïë
    ‚ïë  Ontology: rust-kgdb av: and sensor: namespaces                          ‚ïë
    ‚ïë  Queries: Real SPARQL 1.1 ASK and SELECT execution                       ‚ïë
    ‚ïë  Performance: Sub-20ms query times                                        ‚ïë
    ‚ïë                                                                           ‚ïë
    ‚ïë  This demo showcases:                                                     ‚ïë
    ‚ïë  1. REAL RDF triple loading from Turtle format                           ‚ïë
    ‚ïë  2. REAL SPARQL query execution (not hardcoded!)                         ‚ïë
    ‚ïë  3. Beautiful 3D animation with Three.js                                 ‚ïë
    ‚ïë  4. Native hypergraph visualization                                      ‚ïë
    ‚ïë  5. Explainable AI through semantic reasoning                            ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            overflow: hidden;
        }

        #container {
            display: grid;
            grid-template-rows: 80px 1fr 180px;
            height: 100vh;
        }

        /* TOP BAR */
        #top-bar {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 3px solid #4fc3f7;
            min-height: 80px;
        }

        #scenario-title {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #scenario-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .control-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* MIDDLE - Main Content */
        #middle-section {
            display: grid;
            grid-template-columns: 300px 1fr 520px;
            gap: 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* LEFT - Reasoning Steps */
        #reasoning-panel {
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            overflow-y: auto;
            border-right: 2px solid rgba(79, 195, 247, 0.3);
        }

        .reasoning-step {
            background: linear-gradient(135deg, rgba(103, 58, 183, 0.2) 0%, rgba(63, 81, 181, 0.2) 100%);
            padding: 15px;
            margin: 12px 0;
            border-radius: 12px;
            border-left: 4px solid #7c4dff;
            position: relative;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .step-number {
            position: absolute;
            top: -12px;
            left: 12px;
            background: linear-gradient(135deg, #7c4dff 0%, #536dfe 100%);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.4);
        }

        .step-title {
            font-size: 16px;
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 6px;
            color: #b39ddb;
        }

        .step-content {
            font-size: 13px;
            line-height: 1.5;
            color: #e1bee7;
        }

        .step-result {
            margin-top: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
            color: #ffd54f;
        }

        /* CENTER - 3D Scene */
        #scene-container {
            position: relative;
            background: #0a0e27;
        }

        #scene { width: 100%; height: 100%; }

        /* Distance Overlay */
        #distance-overlay {
            position: absolute;
            top: 15px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #4fc3f7;
            z-index: 10;
            min-width: 200px;
        }

        .distance-item {
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }

        .distance-value {
            color: #4fc3f7;
            font-size: 28px;
            line-height: 1.2;
        }

        /* Speed Indicator */
        #speed-indicator {
            position: absolute;
            bottom: 10px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-radius: 12px;
            border: 3px solid #81c784;
            z-index: 10;
            min-width: 120px;
        }

        .speed-label {
            font-size: 14px;
            color: #81c784;
            margin-bottom: 5px;
        }

        .speed-value {
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            line-height: 1;
        }

        /* API Status Indicator */
        #api-status {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #4caf50;
            z-index: 10;
            font-size: 12px;
        }

        #api-status.error {
            border-color: #f44336;
            color: #f44336;
        }

        #api-status.success {
            border-color: #4caf50;
            color: #4caf50;
        }

        /* RIGHT - Decision & SPARQL/Datalog */
        #decision-panel {
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
            overflow-x: hidden;
            border-left: 2px solid rgba(79, 195, 247, 0.3);
            scroll-behavior: smooth;
        }

        #decision-panel::-webkit-scrollbar {
            width: 10px;
        }

        #decision-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        #decision-panel::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00bcd4 0%, #0097a7 100%);
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.3);
        }

        .decision-box {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3) 0%, rgba(211, 47, 47, 0.3) 100%);
            padding: 25px;
            border-radius: 20px;
            margin: 15px 0;
            border: 4px solid #f44336;
            position: relative;
            animation: fadeIn 0.6s;
        }

        .decision-box.critical {
            animation: pulse 2s infinite, fadeIn 0.6s;
        }

        .decision-box.high {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.3) 0%, rgba(255, 111, 0, 0.3) 100%);
            border-color: #ff9800;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(244, 67, 54, 0.6); }
            50% { box-shadow: 0 0 60px rgba(244, 67, 54, 1); }
        }

        .action-label {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            line-height: 1.2;
        }

        .reason {
            font-size: 14px;
            line-height: 1.5;
            text-align: center;
            margin: 10px 0;
        }

        /* SPARQL Query Box */
        .sparql-box {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2) 0%, rgba(21, 101, 192, 0.2) 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 3px solid #2196f3;
            animation: slideIn 0.7s;
        }

        .sparql-title {
            font-size: 15px;
            font-weight: bold;
            color: #64b5f6;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sparql-query {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre;
            color: #90caf9;
            border: 1px solid rgba(33, 150, 243, 0.3);
            max-height: 150px;
            overflow-y: auto;
        }

        .sparql-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.3);
            border-radius: 6px;
            border-left: 3px solid #4caf50;
            font-weight: bold;
            font-size: 12px;
        }

        .sparql-result.error {
            background: rgba(244, 67, 54, 0.3);
            border-left-color: #f44336;
        }

        /* Datalog Box */
        .datalog-box {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2) 0%, rgba(123, 31, 162, 0.2) 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 3px solid #9c27b0;
            animation: slideIn 0.9s;
        }

        .datalog-title {
            font-size: 15px;
            font-weight: bold;
            color: #ce93d8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .datalog-rule {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 11px;
            padding: 8px 12px;
            margin: 6px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border-left: 3px solid #ba68c8;
            color: #e1bee7;
            line-height: 1.4;
        }

        .datalog-inference {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .inference-step {
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.3;
        }

        .inference-step.given {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196f3;
        }

        .inference-step.infer {
            background: rgba(76, 175, 80, 0.3);
            border-left: 3px solid #4caf50;
            font-weight: bold;
        }

        /* Hypergraph Box */
        .hypergraph-box {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.15) 0%, rgba(0, 150, 136, 0.15) 100%);
            padding: 10px;
            border-radius: 15px;
            margin: 10px 0;
            margin-bottom: 50px;
            border: 3px solid #00bcd4;
            animation: slideIn 1.1s;
        }

        .hypergraph-title {
            font-size: 14px;
            font-weight: bold;
            color: #00e5ff;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hypergraph-svg {
            width: 100%;
            height: 140px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 87, 34, 0.3);
        }

        .hypergraph-legend {
            margin-top: 6px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.4;
            width: 100%;
            box-sizing: border-box;
            overflow: visible;
        }

        .hypergraph-legend-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin: 2px 0;
            width: 100%;
            min-height: fit-content;
        }

        .hypergraph-legend-item span {
            flex: 1;
            overflow-wrap: break-word;
            word-break: break-word;
            font-size: 11px;
            line-height: 1.4;
            white-space: normal;
            overflow: visible;
            max-width: 100%;
        }

        .physics-box {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 10px;
            margin: 12px 0;
            border-left: 4px solid #ffd54f;
        }

        .physics-title {
            font-size: 13px;
            color: #ffd54f;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .physics-formula {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            margin: 5px 0;
        }

        /* BOTTOM - Event Timeline */
        #bottom-bar {
            background: rgba(0, 0, 0, 0.9);
            border-top: 3px solid #4fc3f7;
            padding: 15px 30px;
            overflow-x: auto;
        }

        #event-timeline {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .event {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(56, 142, 60, 0.3) 100%);
            padding: 10px 16px;
            border-radius: 10px;
            border: 2px solid #4caf50;
            min-width: 200px;
            position: relative;
            animation: slideUp 0.5s;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .event-time {
            font-size: 10px;
            color: #81c784;
            margin-bottom: 4px;
        }

        .event-desc {
            font-size: 13px;
            font-weight: bold;
            line-height: 1.3;
        }

        .arrow {
            font-size: 20px;
            color: #4fc3f7;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- TOP BAR -->
        <div id="top-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 0 20px; gap: 15px;">
            <div id="scenario-number" style="flex-shrink: 0;">READY</div>
            <div id="scenario-title" style="flex: 1; text-align: center;">üé¨ Press "Start Scenario" to begin (Server: localhost:8080)</div>
            <div style="display: flex; align-items: center; gap: 6px; background: rgba(76, 175, 80, 0.15); padding: 4px 10px; border-radius: 6px; border: 2px solid #4caf50; flex-shrink: 0;">
                <span style="font-size: 16px;">‚ö°</span>
                <div style="display: flex; flex-direction: column; gap: 0px;">
                    <span style="font-size: 8px; font-weight: bold; color: #4caf50; letter-spacing: 0.5px;">RUST-KGDB</span>
                    <span style="font-size: 12px; font-weight: bold; color: #fff; font-family: monospace; line-height: 1.1;">v0.1.1</span>
                    <span style="font-size: 7px; color: #81c784; line-height: 1.1;">SPARQL 1.1/1.2 + Hypergraph</span>
                </div>
                <span style="font-size: 10px; color: #81c784;">üï∏Ô∏è</span>
            </div>
            <button class="control-btn" onclick="nextScenario()" id="start-btn" style="flex-shrink: 0;">‚ñ∂Ô∏è Start Scenario</button>
        </div>

        <!-- MIDDLE SECTION -->
        <div id="middle-section">
            <!-- LEFT: Reasoning Steps -->
            <div id="reasoning-panel">
                <h2 style="font-size: 24px; margin-bottom: 20px; color: #7c4dff;">üß† Reasoning Process</h2>
                <div id="reasoning-steps">
                    <div style="text-align: center; color: #666; padding: 50px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ü§î</div>
                        <div style="font-size: 18px;">Waiting for scenario...</div>
                        <div style="font-size: 14px; margin-top: 10px; color: #999;">Press "Start Scenario" to see REAL SPARQL reasoning</div>
                    </div>
                </div>
            </div>

            <!-- CENTER: 3D Scene -->
            <div id="scene-container">
                <div id="api-status" class="success">
                    ‚è≥ Checking API...
                </div>

                <div id="distance-overlay">
                    <div class="distance-item">
                        <div style="font-size: 14px; color: #90caf9;">DISTANCE TO OBSTACLE</div>
                        <div class="distance-value" id="distance">-- m</div>
                    </div>
                </div>

                <div id="speed-indicator">
                    <div class="speed-label">SPEED</div>
                    <div class="speed-value" id="speed">0 <span style="font-size: 24px;">km/h</span></div>
                </div>

                <canvas id="scene"></canvas>
            </div>

            <!-- RIGHT: Decision & SPARQL/Datalog -->
            <div id="decision-panel">
                <h2 style="font-size: 20px; margin-bottom: 15px; color: #4fc3f7;">‚ö° Decision Output</h2>
                <div id="decision-container">
                    <div class="decision-box" style="border-color: #666; background: rgba(100, 100, 100, 0.2);">
                        <div class="action-label">‚è∏Ô∏è IDLE</div>
                        <div class="reason">Waiting for scenario to start...</div>
                    </div>
                </div>

                <div id="sparql-container"></div>
                <div id="datalog-container"></div>
                <div id="hypergraph-container"></div>
                <div id="physics-container"></div>
            </div>
        </div>

        <!-- BOTTOM BAR: Event Timeline -->
        <div id="bottom-bar">
            <div style="font-size: 14px; color: #4fc3f7; margin-bottom: 8px; font-weight: bold;">üìä EVENT TIMELINE</div>
            <div id="event-timeline">
                <div class="event" style="opacity: 0.5;">
                    <div class="event-time">T=0.0s</div>
                    <div class="event-desc">‚è≥ Waiting...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}
    </script>

    <script type="module">
        import * as THREE from 'three';

        // ===== API CONFIGURATION =====
        const API_BASE = 'http://localhost:8080';
        let apiHealthy = false;

        // ===== SCENARIO DATA WITH TURTLE RDF =====
        const scenarios = [
            {
                name: "Red Traffic Light Emergency Stop",
                number: "SCENARIO 1/3",
                initialSpeed: 48,
                obstacleType: "traffic_light",
                obstaclePosition: -30,
                safetyMargin: 8,
                // REAL RDF DATA (Turtle format)
                turtleData: `@prefix av: <http://zenya.com/ontology/av#> .
@prefix sensor: <http://zenya.com/ontology/sensor#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

<http://zenya.com/vehicle/ego>
    a av:Vehicle ;
    rdfs:label "Ego Vehicle" ;
    av:hasVelocity "13.3"^^xsd:float ;
    av:positionX "-80.0"^^xsd:float ;
    av:carLength "5.0"^^xsd:float .

<http://zenya.com/traffic_light/tl_001>
    a av:TrafficLight ;
    rdfs:label "Traffic Light 001" ;
    av:state "red"^^xsd:string ;
    av:positionX "-30.0"^^xsd:float ;
    sensor:confidence "0.98"^^xsd:float ;
    av:distanceMeters "30.0"^^xsd:float .`,
                // REAL SPARQL QUERY (will be executed)
                sparqlQuery: `ASK WHERE {
  ?tl <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://zenya.com/ontology/av#TrafficLight> .
  ?tl <http://zenya.com/ontology/av#state> "red" .
}`,
                queryType: 'ask',
                reasoning: [
                    { title: "Sensor Input", content: "Camera detects red traffic light at 30 meters ahead", result: "‚úÖ Confidence: 98%" },
                    { title: "Vehicle State", content: "Current speed: 48 km/h (13.3 m/s)", result: "‚úÖ Position: -80m (approaching)" },
                    { title: "Physics Calculation", content: "Stopping distance = v¬≤/(2√óa√óf)\n= (13.3)¬≤ / (2 √ó 5 √ó 1.0)\n= 17.7m", result: "‚ö†Ô∏è Min: 17.7m, Safe: 27.7m (with 10m margin)" },
                    { title: "Safety Check", content: "Distance to light (30m) < Safe stopping distance (27.7m + 10m)", result: "‚ùå TOO CLOSE - MUST BRAKE!" },
                    { title: "SPARQL Query", content: "ASK { ?tl av:state \"red\" }", result: "‚úÖ Will execute via API" },
                    { title: "Decision", content: "Priority: CRITICAL\nAction: BRAKE 80%\nReason: Red light within stopping distance", result: "üõë EMERGENCY BRAKE ACTIVATED" }
                ],
                decision: { action: "üõë BRAKE 80%", reason: "Red traffic light at 30m (stopping distance: 27.7m)", priority: "critical" },
                datalog: {
                    rules: [
                        "critical(V) :- trafficLight(TL), state(TL, red), distance(V, TL, D), stoppingDistance(V, SD), D < SD + 10.",
                        "action(V, emergencyBrake) :- critical(V)."
                    ],
                    inference: [
                        { type: "given", text: "trafficLight(tl_001) ‚úì" },
                        { type: "given", text: "state(tl_001, red) ‚úì" },
                        { type: "given", text: "distance(ego, tl_001, 30) ‚úì" },
                        { type: "given", text: "stoppingDistance(ego, 27.7) ‚úì" },
                        { type: "given", text: "30 < 27.7 + 10 ‚úì" },
                        { type: "infer", text: "‚áí critical(ego) ‚úì" },
                        { type: "infer", text: "‚áí action(ego, emergencyBrake) ‚úì" }
                    ]
                },
                hypergraph: {
                    nodes: [
                        { id: "vehicle", label: "Vehicle", x: 50, y: 50, color: "#2196f3" },
                        { id: "traffic_light", label: "Traffic\\nLight", x: 250, y: 50, color: "#f44336" },
                        { id: "camera", label: "Camera\\nSensor", x: 50, y: 150, color: "#9c27b0" },
                        { id: "distance", label: "Distance\\n(30m)", x: 150, y: 120, color: "#ffffff" },
                        { id: "physics", label: "Physics\\nEngine", x: 250, y: 150, color: "#ffc107" },
                        { id: "brake", label: "Brake\\nSystem", x: 350, y: 100, color: "#ff5722" }
                    ],
                    hyperedges: [
                        {
                            name: "Detection",
                            nodes: ["camera", "traffic_light", "distance"],
                            color: "rgba(0, 188, 212, 0.4)",
                            label: "H1: Detect"
                        },
                        {
                            name: "Analysis",
                            nodes: ["vehicle", "distance", "physics"],
                            color: "rgba(255, 193, 7, 0.4)",
                            label: "H2: Analyze"
                        },
                        {
                            name: "Emergency Action",
                            nodes: ["traffic_light", "physics", "brake", "vehicle"],
                            color: "rgba(255, 87, 34, 0.4)",
                            label: "H3: Action"
                        }
                    ],
                    description: "Hypergraph: Red light detection involves 4-way relationship between light, physics, brake, and vehicle."
                },
                physics: {
                    title: "Stopping Distance Physics",
                    formulas: [
                        "d = v¬≤ / (2 √ó a √ó f)",
                        "d = (13.3)¬≤ / (2 √ó 5 √ó 1.0) = 17.7m",
                        "Safe distance = 17.7m + 10m = 27.7m",
                        "Actual distance = 30m",
                        "VERDICT: MUST BRAKE"
                    ]
                }
            },
            {
                name: "Pedestrian Crossing Detection",
                number: "SCENARIO 2/3",
                initialSpeed: 36,
                obstacleType: "pedestrian",
                obstaclePosition: -43,
                crosswalkStart: -43,
                carLength: 5,
                safetyMargin: 12,
                turtleData: `@prefix av: <http://zenya.com/ontology/av#> .
@prefix sensor: <http://zenya.com/ontology/sensor#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<http://zenya.com/vehicle/ego>
    a av:Vehicle ;
    av:hasVelocity "10.0"^^xsd:float ;
    av:positionX "-60.0"^^xsd:float .

<http://zenya.com/crosswalk/cw_001>
    a av:Crosswalk ;
    av:positionX "0.0"^^xsd:float .

<http://zenya.com/pedestrian/ped_001>
    a av:Pedestrian ;
    av:positionX "0.0"^^xsd:float ;
    av:inCrosswalk <http://zenya.com/crosswalk/cw_001> .`,
                sparqlQuery: `ASK WHERE {
  ?ped <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://zenya.com/ontology/av#Pedestrian> .
  ?ped <http://zenya.com/ontology/av#inCrosswalk> ?crosswalk .
}`,
                queryType: 'ask',
                reasoning: [
                    { title: "Sensor Input", content: "Camera + LiDAR detect pedestrian in crosswalk at 45m ahead", result: "‚úÖ Confidence: 95%" },
                    { title: "Vehicle State", content: "Current speed: 36 km/h (10 m/s)", result: "‚úÖ Position: -80m (approaching)" },
                    { title: "Safety Rule Check", content: "ISO 26262 & SAE J3016: Pedestrian in crosswalk has absolute priority", result: "‚ö†Ô∏è PEDESTRIAN RIGHT-OF-WAY" },
                    { title: "Trajectory Analysis", content: "Pedestrian path intersects vehicle path\nTime to collision: 1.5 seconds", result: "‚ùå COLLISION IMMINENT!" },
                    { title: "SPARQL Query", content: "ASK { ?ped a av:Pedestrian ; av:inCrosswalk ?cw }", result: "‚úÖ Will execute via API" },
                    { title: "Decision", content: "Priority: CRITICAL\nAction: EMERGENCY BRAKE\nReason: Pedestrian safety is highest priority", result: "üõë EMERGENCY STOP IMMEDIATELY" }
                ],
                decision: { action: "üõë EMERGENCY BRAKE", reason: "Pedestrian in crosswalk - ISO 26262 compliance (absolute priority)", priority: "critical" },
                datalog: {
                    rules: [
                        "critical(V) :- pedestrian(P), inCrosswalk(P), confidence(P, C), C > 0.9.",
                        "rightOfWay(P) :- pedestrian(P), inCrosswalk(P).",
                        "action(V, emergencyBrake) :- critical(V), rightOfWay(P)."
                    ],
                    inference: [
                        { type: "given", text: "pedestrian(ped_001) ‚úì" },
                        { type: "given", text: "inCrosswalk(ped_001) ‚úì" },
                        { type: "given", text: "confidence(ped_001, 0.95) ‚úì" },
                        { type: "given", text: "0.95 > 0.9 ‚úì" },
                        { type: "infer", text: "‚áí critical(ego) ‚úì" },
                        { type: "infer", text: "‚áí rightOfWay(ped_001) ‚úì" },
                        { type: "infer", text: "‚áí action(ego, emergencyBrake) ‚úì" }
                    ]
                },
                hypergraph: {
                    nodes: [
                        { id: "vehicle", label: "Vehicle", x: 50, y: 50, color: "#2196f3" },
                        { id: "pedestrian", label: "Pedestrian", x: 250, y: 50, color: "#4caf50" },
                        { id: "crosswalk", label: "Crosswalk", x: 250, y: 150, color: "#ffffff" },
                        { id: "sensor", label: "Sensor\\n(LiDAR)", x: 50, y: 150, color: "#9c27b0" },
                        { id: "iso26262", label: "ISO 26262\\nSafety", x: 150, y: 250, color: "#ffc107" },
                        { id: "brake", label: "Emergency\\nBrake", x: 350, y: 150, color: "#f44336" }
                    ],
                    hyperedges: [
                        {
                            name: "Detection",
                            nodes: ["sensor", "pedestrian", "crosswalk"],
                            color: "rgba(0, 188, 212, 0.4)",
                            label: "H1: Detection"
                        },
                        {
                            name: "Critical Situation",
                            nodes: ["vehicle", "pedestrian", "crosswalk", "iso26262"],
                            color: "rgba(255, 193, 7, 0.4)",
                            label: "H2: Critical"
                        },
                        {
                            name: "Safety Action",
                            nodes: ["pedestrian", "crosswalk", "iso26262", "brake"],
                            color: "rgba(255, 87, 34, 0.4)",
                            label: "H3: Action"
                        }
                    ],
                    description: "Hypergraph showing 3-way+ relationships. Each colored region is a hyperedge connecting multiple nodes simultaneously."
                },
                physics: {
                    title: "Collision Time Calculation",
                    formulas: [
                        "Vehicle: 10 m/s, Distance: 15m",
                        "Time to crosswalk: 15m / 10m/s = 1.5s",
                        "Pedestrian: 1.4 m/s, Distance: 2m",
                        "Time to path: 2m / 1.4m/s = 1.4s",
                        "VERDICT: EMERGENCY BRAKE (ISO 26262)"
                    ]
                }
            },
            {
                name: "Speed Limit Violation (School Zone)",
                number: "SCENARIO 3/3",
                initialSpeed: 72,
                obstacleType: "school_zone",
                obstaclePosition: -20,
                safetyMargin: 15,
                turtleData: `@prefix av: <http://zenya.com/ontology/av#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<http://zenya.com/vehicle/ego>
    a av:Vehicle ;
    av:hasVelocity "15.0"^^xsd:float .

<http://zenya.com/zone/school_001>
    a av:SchoolZone ;
    av:speedLimit "8.33"^^xsd:float .`,
                sparqlQuery: `SELECT ?zone ?limit ?vehicle ?speed
WHERE {
  ?zone <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://zenya.com/ontology/av#SchoolZone> .
  ?zone <http://zenya.com/ontology/av#speedLimit> ?limit .
  ?vehicle <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://zenya.com/ontology/av#Vehicle> .
  ?vehicle <http://zenya.com/ontology/av#hasVelocity> ?speed .
  FILTER(?speed > ?limit)
}`,
                queryType: 'select',
                reasoning: [
                    { title: "Sensor Input", content: "GPS + Map data detect school zone entry at 40m ahead", result: "‚úÖ Zone ID: SCH_001" },
                    { title: "Vehicle State", content: "Current speed: 72 km/h (20 m/s)", result: "‚ö†Ô∏è Position: -80m (approaching zone)" },
                    { title: "Speed Limit Check", content: "Current: 72 km/h\nSchool Zone Limit: 30 km/h\nViolation: +42 km/h over limit", result: "‚ùå SPEEDING VIOLATION" },
                    { title: "Target Speed", content: "Target = Limit √ó 0.9 (safety margin)\n= 30 √ó 0.9 = 27 km/h", result: "üéØ Target: 27 km/h" },
                    { title: "SPARQL Query", content: "SELECT ?excess WHERE { ... FILTER(?v > ?limit) }", result: "‚úÖ Will execute via API" },
                    { title: "Decision", content: "Priority: HIGH\nAction: BRAKE 60%\nReason: Major speeding violation in school zone", result: "‚ö†Ô∏è DECELERATE TO 27 KM/H" }
                ],
                decision: { action: "‚ö†Ô∏è BRAKE 60%", reason: "Speeding: 72 km/h in 30 km/h school zone (target: 27 km/h)", priority: "high" },
                datalog: {
                    rules: [
                        "violation(V, Z) :- vehicle(V), zone(Z), speed(V, S), limit(Z, L), S > L.",
                        "highPriority(V) :- violation(V, Z), schoolZone(Z).",
                        "action(V, brake60) :- highPriority(V), excess(V, E), E > 10."
                    ],
                    inference: [
                        { type: "given", text: "vehicle(ego) ‚úì" },
                        { type: "given", text: "zone(sch_001), schoolZone(sch_001) ‚úì" },
                        { type: "given", text: "speed(ego, 20), limit(sch_001, 8.3) ‚úì" },
                        { type: "given", text: "20 > 8.3 ‚úì" },
                        { type: "infer", text: "‚áí violation(ego, sch_001) ‚úì" },
                        { type: "infer", text: "‚áí highPriority(ego) ‚úì" },
                        { type: "infer", text: "‚áí action(ego, brake60) ‚úì" }
                    ]
                },
                hypergraph: {
                    nodes: [
                        { id: "vehicle", label: "Vehicle", x: 50, y: 50, color: "#2196f3" },
                        { id: "school_zone", label: "School\\nZone", x: 250, y: 50, color: "#ffc107" },
                        { id: "gps", label: "GPS +\\nMap Data", x: 50, y: 150, color: "#9c27b0" },
                        { id: "speed_limit", label: "Speed\\nLimit (30)", x: 150, y: 150, color: "#ffffff" },
                        { id: "violation", label: "Violation\\n(42 over)", x: 250, y: 150, color: "#f44336" },
                        { id: "brake", label: "Brake\\n60%", x: 350, y: 100, color: "#ff5722" }
                    ],
                    hyperedges: [
                        {
                            name: "Zone Detection",
                            nodes: ["gps", "school_zone", "speed_limit"],
                            color: "rgba(0, 188, 212, 0.4)",
                            label: "H1: Detect"
                        },
                        {
                            name: "Violation Analysis",
                            nodes: ["vehicle", "speed_limit", "violation"],
                            color: "rgba(255, 193, 7, 0.4)",
                            label: "H2: Analyze"
                        },
                        {
                            name: "Enforcement Action",
                            nodes: ["school_zone", "violation", "brake", "vehicle"],
                            color: "rgba(255, 87, 34, 0.4)",
                            label: "H3: Enforce"
                        }
                    ],
                    description: "Hypergraph: School zone enforcement involves 4-way relationship between zone, violation, brake, and vehicle."
                },
                physics: {
                    title: "Deceleration Required",
                    formulas: [
                        "Current: 72 km/h = 20 m/s",
                        "Target: 27 km/h = 7.5 m/s",
                        "Distance: 40 meters",
                        "a = (7.5¬≤ - 20¬≤) / (2 √ó 40)",
                        "a = -4.3 m/s¬≤",
                        "BRAKE INTENSITY: 60%"
                    ]
                }
            }
        ];

        // ===== THREEJS SCENE VARIABLES =====
        let scene, camera, renderer, egoVehicle, obstacle;
        let currentScenario = 0;
        let animationActive = false;
        let carPosition = -80;
        let events = [];

        // ===== API FUNCTIONS =====
        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                apiHealthy = true;
                document.getElementById('api-status').textContent = `‚úÖ API Ready (${data.triples} triples)`;
                document.getElementById('api-status').className = 'success';
                return true;
            } catch (error) {
                apiHealthy = false;
                document.getElementById('api-status').textContent = `‚ùå API Offline`;
                document.getElementById('api-status').className = 'error';
                console.error('API health check failed:', error);
                return false;
            }
        }

        async function loadScenarioData(scenario) {
            try {
                addEvent("API Call", "üì• Loading RDF triples...");

                // Clear store first
                await fetch(`${API_BASE}/clear`, { method: 'POST' });

                // Load RDF data
                const loadResponse = await fetch(`${API_BASE}/load`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ turtle_data: scenario.turtleData })
                });

                const loadResult = await loadResponse.json();

                if (!loadResult.success) {
                    throw new Error(loadResult.error || 'Failed to load RDF data');
                }

                addEvent("RDF Loaded", `‚úÖ ${loadResult.triples_loaded} triples in ${loadResult.execution_time_ms.toFixed(2)}ms`);
                return loadResult;
            } catch (error) {
                addEvent("Error", `‚ùå Load failed: ${error.message}`);
                throw error;
            }
        }

        async function executeSparqlQuery(scenario) {
            try {
                addEvent("SPARQL Query", "üîç Executing query...");

                const queryType = scenario.queryType;
                const queryResponse = await fetch(`${API_BASE}/${queryType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sparql_query: scenario.sparqlQuery })
                });

                const queryResult = await queryResponse.json();

                if (!queryResult.success) {
                    throw new Error(queryResult.error || 'Query execution failed');
                }

                const execTimeMs = (queryResult.execution_time_us / 1000).toFixed(2);
                addEvent("Query Result", `‚úÖ Executed in ${execTimeMs}ms`);

                return queryResult;
            } catch (error) {
                addEvent("Error", `‚ùå Query failed: ${error.message}`);
                throw error;
            }
        }

        // ===== THREE.JS SCENE SETUP =====
        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 30, 150);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 35, 70);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('scene'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight.position.set(30, 60, 40);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);

            const roadGeometry = new THREE.PlaneGeometry(200, 20);
            const roadMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a1a1a,
                roughness: 0.9,
                metalness: 0.1
            });
            const road = new THREE.Mesh(roadGeometry, roadMaterial);
            road.rotation.x = -Math.PI / 2;
            road.receiveShadow = true;
            scene.add(road);

            for (let i = -90; i < 100; i += 10) {
                const marking = new THREE.Mesh(
                    new THREE.BoxGeometry(4, 0.15, 0.5),
                    new THREE.MeshBasicMaterial({ color: 0xffeb3b })
                );
                marking.position.set(i, 0.08, 0);
                scene.add(marking);
            }

            for (let i = -80; i <= 60; i += 20) {
                const markerGroup = new THREE.Group();
                const pole = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.1, 0.1, 3),
                    new THREE.MeshStandardMaterial({ color: 0x666666 })
                );
                pole.position.y = 1.5;
                markerGroup.add(pole);
                const sign = new THREE.Mesh(
                    new THREE.BoxGeometry(1.5, 0.8, 0.1),
                    new THREE.MeshStandardMaterial({ color: 0x2196f3 })
                );
                sign.position.y = 3.5;
                markerGroup.add(sign);
                markerGroup.position.set(i, 0, -12);
                scene.add(markerGroup);
            }

            createEgoVehicle();
            animate();
        }

        function createEgoVehicle() {
            const carGroup = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(5, 2, 2.5),
                new THREE.MeshStandardMaterial({
                    color: 0x2196f3,
                    metalness: 0.8,
                    roughness: 0.2,
                    emissive: 0x0d47a1,
                    emissiveIntensity: 0.2
                })
            );
            body.position.y = 1;
            body.castShadow = true;
            carGroup.add(body);

            const cabin = new THREE.Mesh(
                new THREE.BoxGeometry(2.5, 1.3, 2.3),
                new THREE.MeshStandardMaterial({
                    color: 0x1976d2,
                    metalness: 0.9,
                    roughness: 0.1
                })
            );
            cabin.position.set(-0.5, 2.65, 0);
            cabin.castShadow = true;
            carGroup.add(cabin);

            const headlightGeometry = new THREE.SphereGeometry(0.2);
            const headlightMaterial = new THREE.MeshStandardMaterial({
                color: 0xffff00,
                emissive: 0xffff00,
                emissiveIntensity: 2
            });

            const leftHeadlight = new THREE.Mesh(headlightGeometry, headlightMaterial);
            leftHeadlight.position.set(2.6, 0.8, -0.8);
            carGroup.add(leftHeadlight);

            const rightHeadlight = new THREE.Mesh(headlightGeometry, headlightMaterial);
            rightHeadlight.position.set(2.6, 0.8, 0.8);
            carGroup.add(rightHeadlight);

            const wheelGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.4, 16);
            const wheelMaterial = new THREE.MeshStandardMaterial({ color: 0x222222 });

            for (let x of [-1.5, 1.5]) {
                for (let z of [-1.3, 1.3]) {
                    const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                    wheel.rotation.z = Math.PI / 2;
                    wheel.position.set(x, 0.5, z);
                    wheel.castShadow = true;
                    carGroup.add(wheel);
                }
            }

            carGroup.position.set(-80, 1, 0);
            egoVehicle = carGroup;
            scene.add(egoVehicle);
        }

        function createObstacle(type, position) {
            if (obstacle) scene.remove(obstacle);

            if (type === 'traffic_light') {
                obstacle = createTrafficLight();
            } else if (type === 'pedestrian') {
                obstacle = createPedestrian();
                if (position !== undefined) {
                    obstacle.position.x = position;
                }
            } else if (type === 'school_zone') {
                obstacle = createSchoolZoneSign();
            }

            scene.add(obstacle);
        }

        function createTrafficLight() {
            const group = new THREE.Group();
            const pole = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.3, 12),
                new THREE.MeshStandardMaterial({ color: 0x333333 })
            );
            pole.position.y = 6;
            pole.castShadow = true;
            group.add(pole);

            const box = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 4, 1.5),
                new THREE.MeshStandardMaterial({ color: 0x111111 })
            );
            box.position.y = 13;
            box.castShadow = true;
            group.add(box);

            const redLight = new THREE.Mesh(
                new THREE.SphereGeometry(0.6),
                new THREE.MeshStandardMaterial({
                    color: 0xff0000,
                    emissive: 0xff0000,
                    emissiveIntensity: 5
                })
            );
            redLight.position.set(0, 14, 0.8);
            group.add(redLight);

            const glow = new THREE.PointLight(0xff0000, 5, 40);
            glow.position.set(0, 14, 0.8);
            group.add(glow);

            group.position.set(-30, 0, -7);
            return group;
        }

        function createPedestrian() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 2.5),
                new THREE.MeshStandardMaterial({ color: 0x4caf50 })
            );
            body.position.y = 2.5;
            body.castShadow = true;
            group.add(body);

            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.6),
                new THREE.MeshStandardMaterial({ color: 0xffccbc })
            );
            head.position.y = 4.2;
            head.castShadow = true;
            group.add(head);

            for (let i = -8; i < 9; i += 2) {
                const stripe = new THREE.Mesh(
                    new THREE.PlaneGeometry(2, 12),
                    new THREE.MeshStandardMaterial({
                        color: 0xffffff,
                        transparent: true,
                        opacity: 0.95,
                        emissive: 0xcccccc,
                        emissiveIntensity: 0.2
                    })
                );
                stripe.rotation.x = -Math.PI / 2;
                stripe.position.set(i, 0.03, 0);
                group.add(stripe);
            }

            group.position.set(-43, 0, 0);
            return group;
        }

        function createSchoolZoneSign() {
            const group = new THREE.Group();
            const pole = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 6),
                new THREE.MeshStandardMaterial({ color: 0x555555 })
            );
            pole.position.y = 3;
            pole.castShadow = true;
            group.add(pole);

            const sign = new THREE.Mesh(
                new THREE.BoxGeometry(4, 4, 0.2),
                new THREE.MeshStandardMaterial({
                    color: 0xffeb3b,
                    emissive: 0xfbc02d,
                    emissiveIntensity: 0.3
                })
            );
            sign.position.y = 7;
            sign.castShadow = true;
            group.add(sign);

            const textMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            const digit3_1 = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.5, 0.1), textMaterial);
            digit3_1.position.set(-0.8, 7, 0.15);
            group.add(digit3_1);
            const digit3_2 = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.3, 0.1), textMaterial);
            digit3_2.position.set(-0.6, 7.6, 0.15);
            group.add(digit3_2);

            const digit0 = new THREE.Mesh(
                new THREE.TorusGeometry(0.6, 0.2, 8, 16),
                textMaterial
            );
            digit0.position.set(0.6, 7, 0.15);
            group.add(digit0);

            group.position.set(-20, 0, -8);
            return group;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (animationActive) {
                const scenario = scenarios[currentScenario];

                let stopPosition;
                if (scenario.crosswalkStart) {
                    const crosswalkEdge = scenario.crosswalkStart + 1;
                    const carFrontStopPosition = crosswalkEdge - scenario.safetyMargin;
                    stopPosition = carFrontStopPosition - (scenario.carLength / 2);
                } else {
                    stopPosition = scenario.obstaclePosition - scenario.safetyMargin;
                }

                if (carPosition < stopPosition) {
                    carPosition += 0.15;
                    if (carPosition > stopPosition) {
                        carPosition = stopPosition;
                    }
                    egoVehicle.position.x = carPosition;
                } else {
                    if (animationActive) {
                        animationActive = false;
                        addEvent("Vehicle stopped", "‚úÖ Braking complete - Safe stop achieved");
                        currentScenario = (currentScenario + 1) % scenarios.length;
                    }
                }

                let distanceTarget = scenario.obstaclePosition;
                if (scenario.crosswalkStart) {
                    const carFront = carPosition + (scenario.carLength / 2);
                    distanceTarget = scenario.crosswalkStart - carFront;
                    document.getElementById('distance').textContent = Math.max(0, distanceTarget).toFixed(1) + ' m to crosswalk';
                } else {
                    const distance = Math.max(0, distanceTarget - carPosition);
                    document.getElementById('distance').textContent = distance.toFixed(1) + ' m';
                }
            }

            renderer.render(scene, camera);
        }

        function addEvent(time, desc) {
            const timeline = document.getElementById('event-timeline');
            const event = document.createElement('div');
            event.className = 'event';
            event.innerHTML = `
                <div class="event-time">${time}</div>
                <div class="event-desc">${desc}</div>
            `;
            timeline.appendChild(event);

            const arrow = document.createElement('div');
            arrow.className = 'arrow';
            arrow.textContent = '‚Üí';
            timeline.appendChild(arrow);

            timeline.parentElement.scrollLeft = timeline.scrollWidth;
        }

        // ===== MAIN SCENARIO EXECUTION =====
        window.nextScenario = async function() {
            if (animationActive) return;

            const btn = document.getElementById('start-btn');
            btn.disabled = true;

            const scenario = scenarios[currentScenario];

            console.log('=== SCENARIO STARTING ===');
            console.log('Scenario:', scenario.name);

            // Check API health
            const apiOk = await checkApiHealth();
            if (!apiOk) {
                alert('‚ùå Cannot connect to SPARQL API at ' + API_BASE + '\n\nMake sure av-server is running:\npython3 av-wasm/server.py');
                btn.disabled = false;
                return;
            }

            try {
                // Reset scene
                carPosition = -80;
                egoVehicle.position.x = carPosition;
                document.getElementById('event-timeline').innerHTML = '';

                // Update UI
                document.getElementById('scenario-number').textContent = scenario.number;
                document.getElementById('scenario-title').textContent = 'üöó ' + scenario.name;
                document.getElementById('speed').innerHTML = `${scenario.initialSpeed} <span style="font-size: 24px;">km/h</span>`;

                // Create obstacle
                createObstacle(scenario.obstacleType, scenario.obstaclePosition);

                // Show reasoning steps
                const stepsHTML = scenario.reasoning.map((step, i) => `
                    <div class="reasoning-step">
                        <div class="step-number">${i + 1}</div>
                        <div class="step-title">${step.title}</div>
                        <div class="step-content">${step.content}</div>
                        <div class="step-result">${step.result}</div>
                    </div>
                `).join('');
                document.getElementById('reasoning-steps').innerHTML = stepsHTML;

                // Show decision
                const dec = scenario.decision;
                document.getElementById('decision-container').innerHTML = `
                    <div class="decision-box ${dec.priority}">
                        <div class="action-label">${dec.action}</div>
                        <div class="reason">${dec.reason}</div>
                    </div>
                `;

                // === REAL API INTEGRATION ===
                // Load RDF data
                const loadResult = await loadScenarioData(scenario);

                // Execute SPARQL query
                const queryResult = await executeSparqlQuery(scenario);

                // Display REAL query result
                let sparqlResultHTML;
                if (scenario.queryType === 'ask') {
                    const decision = queryResult.result ? 'üõë EMERGENCY BRAKE' : '‚úÖ SAFE TO PROCEED';
                    const color = queryResult.result ? 'error' : 'success';
                    sparqlResultHTML = `<div class="sparql-result ${queryResult.result ? '' : color}">
                        <strong>REAL SPARQL ASK Result:</strong> ${queryResult.result ? 'TRUE' : 'FALSE'}<br>
                        <strong>Decision:</strong> ${decision}<br>
                        <strong>Execution Time:</strong> ${(queryResult.execution_time_us / 1000).toFixed(2)} ms
                    </div>`;
                } else {
                    sparqlResultHTML = `<div class="sparql-result">
                        <strong>REAL SPARQL SELECT Result:</strong><br>
                        Bindings: ${queryResult.count}<br>
                        ${queryResult.bindings.length > 0 ?
                            `<pre>${JSON.stringify(queryResult.bindings[0], null, 2)}</pre>` :
                            'No results'
                        }<br>
                        <strong>Execution Time:</strong> ${(queryResult.execution_time_us / 1000).toFixed(2)} ms
                    </div>`;
                }

                document.getElementById('sparql-container').innerHTML = `
                    <div class="sparql-box">
                        <div class="sparql-title">üîç REAL SPARQL Query Executed:</div>
                        <div class="sparql-query">${scenario.sparqlQuery}</div>
                        ${sparqlResultHTML}
                    </div>
                `;

                // Show Datalog
                const datalogRulesHTML = scenario.datalog.rules.map(rule =>
                    `<div class="datalog-rule">${rule}</div>`
                ).join('');

                const datalogInferenceHTML = scenario.datalog.inference.map(step =>
                    `<div class="inference-step ${step.type}">${step.text}</div>`
                ).join('');

                document.getElementById('datalog-container').innerHTML = `
                    <div class="datalog-box">
                        <div class="datalog-title">üßÆ Datalog Inference Rules:</div>
                        ${datalogRulesHTML}
                        <div class="datalog-inference">
                            <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #ba68c8;">Inference Chain:</div>
                            ${datalogInferenceHTML}
                        </div>
                    </div>
                `;

                // Show Hypergraph
                if (scenario.hypergraph) {
                    const hg = scenario.hypergraph;
                    let svgContent = '<svg viewBox="0 0 400 300" class="hypergraph-svg">';

                    hg.hyperedges.forEach((hedge, idx) => {
                        const edgeNodes = hedge.nodes.map(nid => hg.nodes.find(n => n.id === nid));
                        const centerX = edgeNodes.reduce((sum, n) => sum + n.x, 0) / edgeNodes.length;
                        const centerY = edgeNodes.reduce((sum, n) => sum + n.y, 0) / edgeNodes.length;

                        const points = edgeNodes.map(n => `${n.x},${n.y}`).join(' ');
                        svgContent += `<polygon points="${points}" fill="${hedge.color}" stroke="${hedge.color.replace('0.4', '0.9')}" stroke-width="2.5"/>`;

                        const labelBgWidth = hedge.label.length * 7;
                        svgContent += `<rect x="${centerX - labelBgWidth/2}" y="${centerY - 22}" width="${labelBgWidth}" height="18" fill="rgba(0,0,0,0.85)" stroke="#fff" stroke-width="1.5" rx="3"/>`;
                        svgContent += `<text x="${centerX}" y="${centerY - 10}" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">${hedge.label}</text>`;

                        for (let i = 0; i < edgeNodes.length; i++) {
                            for (let j = i + 1; j < edgeNodes.length; j++) {
                                svgContent += `<line x1="${edgeNodes[i].x}" y1="${edgeNodes[i].y}" x2="${edgeNodes[j].x}" y2="${edgeNodes[j].y}" stroke="rgba(255,255,255,0.2)" stroke-width="1"/>`;
                            }
                        }
                    });

                    hg.nodes.forEach(node => {
                        svgContent += `<circle cx="${node.x}" cy="${node.y}" r="22" fill="${node.color}" stroke="#fff" stroke-width="2.5"/>`;
                        const lines = node.label.split('\\n');
                        lines.forEach((line, idx) => {
                            const yOffset = lines.length === 1 ? 5 : (idx - (lines.length - 1) / 2) * 11 + 5;
                            svgContent += `<text x="${node.x}" y="${node.y + yOffset}" text-anchor="middle" fill="#000" font-size="11" font-weight="bold" stroke="#fff" stroke-width="3" paint-order="stroke">${line}</text>`;
                            svgContent += `<text x="${node.x}" y="${node.y + yOffset}" text-anchor="middle" fill="#000" font-size="11" font-weight="bold">${line}</text>`;
                        });
                    });

                    svgContent += '</svg>';

                    const legendHTML = hg.hyperedges.map(hedge =>
                        `<div class="hypergraph-legend-item">
                            <div style="width: 28px; min-width: 28px; height: 8px; flex-shrink: 0; background: ${hedge.color}; border: 1px solid ${hedge.color.replace('0.4', '0.9')}; border-radius: 3px; margin-top: 4px;"></div>
                            <span>${hedge.label}: {${hedge.nodes.join(', ')}}</span>
                        </div>`
                    ).join('');

                    document.getElementById('hypergraph-container').innerHTML = `
                        <div class="hypergraph-box">
                            <div class="hypergraph-title">üï∏Ô∏è Hypergraph Reasoning (N-ary Relations):</div>
                            ${svgContent}
                            <div class="hypergraph-legend">
                                <div style="font-weight: bold; margin-bottom: 3px; color: #00bcd4; font-size: 11px;">Hyperedges (multi-way connections):</div>
                                ${legendHTML}
                                <div style="margin-top: 4px; font-style: italic; color: #4dd0e1; font-size: 9px;">${hg.description}</div>
                            </div>
                        </div>
                    `;
                }

                // Show physics
                document.getElementById('physics-container').innerHTML = `
                    <div class="physics-box">
                        <div class="physics-title">‚öôÔ∏è ${scenario.physics.title}</div>
                        <div class="physics-formula">${scenario.physics.formulas.join('\n')}</div>
                    </div>
                `;

                // Start animation
                animationActive = true;

                // Add events
                addEvent("T=0.0s", "üöó Scenario started - Vehicle moving at " + scenario.initialSpeed + " km/h");
                setTimeout(() => addEvent("T=0.5s", "üì∏ Sensor detection: " + scenario.obstacleType), 500);

                const btn = document.querySelector('.control-btn');
                const nextScenarioNum = (currentScenario + 1) % scenarios.length;
                btn.textContent = nextScenarioNum === 0 ? 'üîÑ Restart Scenarios' : '‚ñ∂Ô∏è Next Scenario';
                btn.disabled = false;

            } catch (error) {
                console.error('Scenario execution failed:', error);
                addEvent("ERROR", `‚ùå ${error.message}`);

                document.getElementById('sparql-container').innerHTML = `
                    <div class="sparql-box">
                        <div class="sparql-title">‚ùå SPARQL Execution Failed</div>
                        <div class="sparql-result error">
                            Error: ${error.message}<br>
                            Make sure av-server is running on localhost:8080
                        </div>
                    </div>
                `;

                btn.disabled = false;
            }
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize scene and check API
        initScene();
        checkApiHealth();
    </script>
</body>
</html>
